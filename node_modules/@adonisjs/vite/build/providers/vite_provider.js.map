{"version":3,"sources":["../../providers/vite_provider.ts"],"sourcesContent":["/*\n * @adonisjs/vite\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type { ApplicationService } from '@adonisjs/core/types'\nimport type { cspKeywords as ShieldCSPKeywords } from '@adonisjs/shield'\n\nimport { Vite } from '../src/vite.js'\nimport type { ViteOptions } from '../src/types.js'\nimport ViteMiddleware from '../src/vite_middleware.js'\n\ndeclare module '@adonisjs/core/types' {\n  interface ContainerBindings {\n    vite: Vite\n  }\n}\n\nexport default class ViteProvider {\n  #shouldRunVite: boolean\n\n  constructor(protected app: ApplicationService) {\n    /**\n     * We should only run Vite in development and test environments\n     */\n    const env = this.app.getEnvironment()\n    this.#shouldRunVite = (this.app.inDev || this.app.inTest) && (env === 'web' || env === 'test')\n  }\n\n  /**\n   * Registers edge plugin when edge is installed\n   */\n  protected async registerEdgePlugin() {\n    if (this.app.usingEdgeJS) {\n      const edge = await import('edge.js')\n      const vite = await this.app.container.make('vite')\n      const { edgePluginVite } = await import('../src/plugins/edge.js')\n      edge.default.use(edgePluginVite(vite))\n    }\n  }\n\n  /**\n   * Registers CSP keywords when @adonisjs/shield is installed\n   */\n  protected async registerShieldKeywords() {\n    let cspKeywords: typeof ShieldCSPKeywords | null = null\n    try {\n      const shieldExports = await import('@adonisjs/shield')\n      cspKeywords = shieldExports.cspKeywords\n    } catch {}\n\n    if (!cspKeywords) return\n\n    const vite = await this.app.container.make('vite')\n\n    /**\n     * Registering the @viteUrl keyword for CSP directives.\n     * Returns http URL to the dev or the CDN server, otherwise\n     * an empty string\n     */\n    cspKeywords.register('@viteUrl', function () {\n      const assetsURL = vite.assetsUrl()\n      if (!assetsURL || !assetsURL.startsWith('http://') || assetsURL.startsWith('https://')) {\n        return ''\n      }\n\n      return assetsURL\n    })\n  }\n\n  /**\n   * Register Vite bindings\n   */\n  register() {\n    const config = this.app.config.get<ViteOptions>('vite')\n\n    const vite = new Vite(this.#shouldRunVite, config)\n    this.app.container.bind('vite', () => vite)\n    this.app.container.singleton(ViteMiddleware, () => new ViteMiddleware(vite))\n  }\n\n  /**\n   * - Register edge tags\n   * - Start Vite server when running in development or test\n   */\n  async boot() {\n    await this.registerEdgePlugin()\n\n    if (!this.#shouldRunVite) return\n\n    const vite = await this.app.container.make('vite')\n    await vite.createDevServer()\n  }\n\n  /**\n   * Stop Vite server when running in development or test\n   */\n  async shutdown() {\n    if (!this.#shouldRunVite) return\n\n    const vite = await this.app.container.make('vite')\n    await vite.stopDevServer()\n  }\n}\n"],"mappings":";;;;;;;;;AAsBA,IAAqB,eAArB,MAAkC;AAAA,EAGhC,YAAsB,KAAyB;AAAzB;AAIpB,UAAM,MAAM,KAAK,IAAI,eAAe;AACpC,SAAK,kBAAkB,KAAK,IAAI,SAAS,KAAK,IAAI,YAAY,QAAQ,SAAS,QAAQ;AAAA,EACzF;AAAA,EARA;AAAA;AAAA;AAAA;AAAA,EAaA,MAAgB,qBAAqB;AACnC,QAAI,KAAK,IAAI,aAAa;AACxB,YAAM,OAAO,MAAM,OAAO,SAAS;AACnC,YAAM,OAAO,MAAM,KAAK,IAAI,UAAU,KAAK,MAAM;AACjD,YAAM,EAAE,eAAe,IAAI,MAAM,OAAO,wBAAwB;AAChE,WAAK,QAAQ,IAAI,eAAe,IAAI,CAAC;AAAA,IACvC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAgB,yBAAyB;AACvC,QAAI,cAA+C;AACnD,QAAI;AACF,YAAM,gBAAgB,MAAM,OAAO,kBAAkB;AACrD,oBAAc,cAAc;AAAA,IAC9B,QAAQ;AAAA,IAAC;AAET,QAAI,CAAC;AAAa;AAElB,UAAM,OAAO,MAAM,KAAK,IAAI,UAAU,KAAK,MAAM;AAOjD,gBAAY,SAAS,YAAY,WAAY;AAC3C,YAAM,YAAY,KAAK,UAAU;AACjC,UAAI,CAAC,aAAa,CAAC,UAAU,WAAW,SAAS,KAAK,UAAU,WAAW,UAAU,GAAG;AACtF,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,IACT,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW;AACT,UAAM,SAAS,KAAK,IAAI,OAAO,IAAiB,MAAM;AAEtD,UAAM,OAAO,IAAI,KAAK,KAAK,gBAAgB,MAAM;AACjD,SAAK,IAAI,UAAU,KAAK,QAAQ,MAAM,IAAI;AAC1C,SAAK,IAAI,UAAU,UAAU,gBAAgB,MAAM,IAAI,eAAe,IAAI,CAAC;AAAA,EAC7E;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,OAAO;AACX,UAAM,KAAK,mBAAmB;AAE9B,QAAI,CAAC,KAAK;AAAgB;AAE1B,UAAM,OAAO,MAAM,KAAK,IAAI,UAAU,KAAK,MAAM;AACjD,UAAM,KAAK,gBAAgB;AAAA,EAC7B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,WAAW;AACf,QAAI,CAAC,KAAK;AAAgB;AAE1B,UAAM,OAAO,MAAM,KAAK,IAAI,UAAU,KAAK,MAAM;AACjD,UAAM,KAAK,cAAc;AAAA,EAC3B;AACF;","names":[]}